let bleDevice = null;
let bleServer = null;
let bleCharacteristic = null;

async function connectBle() {
  try {
    bleDevice = await navigator.bluetooth.requestDevice({
      filters: [{ services: ['0000ffe0-0000-1000-8000-00805f9b34fb'] }],
      optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb']
    });

    bleDevice.addEventListener('gattserverdisconnected', () => {
      console.log("BLE切断されました");
    });

    bleServer = await bleDevice.gatt.connect();
    const service = await bleServer.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
    bleCharacteristic = await service.getCharacteristic('0000ffe0-0000-1000-8000-00805f9b34fb');

    await bleCharacteristic.startNotifications();
    bleCharacteristic.addEventListener('characteristicvaluechanged', handleBleData);

    console.log("BLE接続成功");

  } catch (error) {
    console.error("BLE接続失敗:", error);
    alert("BLE接続失敗: " + error.message);
  }
}

function handleBleData(event) {
  const value = new TextDecoder().decode(event.target.value);
  console.log("受信データ:", value);
}