<!DOCTYPE html>
<html lang="ja">
<head>
<link rel="manifest" href="/ble-pwa-app/manifest.json">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>ATHLETE'S LOAD</title>
<style>
  /* Reset */
  * {
    margin: 0; padding: 0; box-sizing: border-box;
  }
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #1E3C72 0%, #2A5298 100%);
    color: #f0f0f0;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 20px 10px 40px;
  }
  .app-container {
    background: #152f5c;
    border-radius: 24px;
    width: 100%;
    max-width: 420px;
    box-shadow: 0 15px 30px rgba(0,0,0,0.5);
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  header {
    background: #0d2249;
    padding: 20px 24px;
    display: flex;
    align-items: center;
    gap: 14px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    position: relative;
  }
  header svg {
    width: 38px;
    height: 38px;
    fill: #58a6ff;
  }
  header h1 {
    font-size: 1.8rem;
    font-weight: 700;
    letter-spacing: 1.3px;
    color: #58a6ff;
    user-select: none;
    flex-grow: 1;
  }
  #bleStatus {
    position: absolute;
    top: 16px;
    right: 16px;
    background: #304a7e88;
    border-radius: 20px;
    padding: 6px 14px;
    font-size: 14px;
    color: #d0e6ff;
    display: flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.5);
    user-select: none;
    z-index: 1000;
  }
  #bleIcon {
    font-size: 18px;
  }

  main {
    padding: 24px 20px 32px;
    flex-grow: 1;
  }

  .screen {
    display: none;
    flex-direction: column;
    gap: 20px;
  }
  .screen.active {
    display: flex;
  }

  h2 {
    font-size: 1.6rem;
    font-weight: 700;
    color: #bbe1ff;
    user-select: none;
  }

  button {
    background: #2f64d6;
    border: none;
    border-radius: 14px;
    color: #f0f9ff;
    font-size: 1.2rem;
    font-weight: 600;
    padding: 16px;
    cursor: pointer;
    box-shadow: 0 6px 12px #1a3a74cc;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    user-select: none;
    text-align: center;
  }
  button:hover,
  button:focus {
    background: #5089ff;
    box-shadow: 0 8px 20px #2a65e6cc;
    outline: none;
  }
  button:active {
    background: #1d3f98;
    box-shadow: 0 4px 8px #173071cc;
  }

  #countdown {
    font-size: 4.5rem;
    font-weight: 800;
    color: #ffcc00;
    text-align: center;
    text-shadow: 0 0 12px #ffcc0088;
    user-select: none;
    min-height: 2.5em;
  }

  #measurementManual,
  #measurementAuto {
    font-weight: 700;
    font-size: 3rem;
    color: #dce9ff;
    text-align: center;
    text-shadow: 0 0 8px #78a7ffbb;
    user-select: none;
    min-height: 2em;
  }

  .extra-controls {
    display: flex;
    justify-content: space-between;
    gap: 14px;
  }

  /* è¨­å®šã‚«ãƒ¼ãƒ‰ */
  .setting-card {
    background: #254a90;
    padding: 16px 20px;
    border-radius: 18px;
    box-shadow: inset 0 0 15px #1a3872;
  }
  .setting-card label {
    display: block;
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 10px;
    color: #aad4ff;
  }
  select,
  input[type=number],
  input[type=range] {
    width: 100%;
    border-radius: 14px;
    border: none;
    padding: 14px 18px;
    font-size: 1.1rem;
    font-weight: 600;
    color: #0d2249;
    background: #a3c2ff;
    box-shadow: inset 0 3px 6px #7099ff;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    cursor: pointer;
    user-select: none;
  }

  /* ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ */
  .radio-group {
    display: flex;
    gap: 20px;
    justify-content: center;
  }
  .radio-group label {
    cursor: pointer;
    user-select: none;
    font-weight: 700;
    font-size: 1.1rem;
    color: #bbe1ff;
  }
  .radio-group input[type="radio"] {
    accent-color: #58a6ff;
    margin-right: 6px;
    cursor: pointer;
  }

  /* éŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
  input[type=range] {
    -webkit-appearance: none;
    height: 8px;
    background: #5280ff;
    outline: none;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 28px;
    height: 28px;
    background: #ffe066;
    cursor: pointer;
    border-radius: 50%;
    border: 2px solid #ffaa00;
    box-shadow: 0 0 8px #ffaa0077;
    margin-top: -10px;
  }
  input[type=range]::-moz-range-thumb {
    width: 28px;
    height: 28px;
    background: #ffe066;
    cursor: pointer;
    border-radius: 50%;
    border: 2px solid #ffaa00;
    box-shadow: 0 0 8px #ffaa0077;
  }
  
  #fixedTab, #randomTab {
    padding: 10px 16px;
    font-size: 16px;
    white-space: nowrap;     /* â† æ”¹è¡Œã•ã›ãªã„ */
    min-width: 120px;         /* â† æœ€å°å¹…ã‚’ç¢ºä¿ */
    border-radius: 8px;
    border: 1px solid #ccc;
    background-color: #f0f0f0;
    box-sizing: border-box;
  }

  .active-tab {
    background-color: #4caf50;
    color: white;
  }

  @media (max-width: 480px) {
    #fixedTab, #randomTab {
      font-size: 14px;
      padding: 8px 12px;
      min-width: 100px;
    }
  }

</style>
</head>
<body>
  <div class="app-container" role="main" aria-label="ATHLETE'S LOAD">

    <header>
      <h1>ATHLETE'S LOAD</h1>
      <div id="bleStatus" aria-live="polite">
        <span id="bleIcon" aria-hidden="true">ğŸ”´</span>
        <span id="bleText">æœªæ¥ç¶š</span>
      </div>
    </header>

    <main>
      <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ -->
      <section id="menuScreen" class="screen active" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢">
        <button id="connectBtn" aria-label="æ¥ç¶šé–‹å§‹">BLEæ¥ç¶š</button>
        <button onclick="showScreen('manualScreen')" aria-label="æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã¸">æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰</button>
        <button onclick="showScreen('autoScreen')" aria-label="è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã¸">è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰</button>
        <button onclick="showScreen('settingsMenuScreen')" aria-label="è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸">è¨­å®š</button>
      </section>

      <!-- è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
      <section id="settingsMenuScreen" class="screen" aria-label="è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼">
        <button onclick="showScreen('settingsScreen')">éŸ³å£°è¨­å®š</button>
        <button onclick="showScreen('startSettingsScreen')">ã‚¹ã‚¿ãƒ¼ãƒˆè¨­å®š</button>
        <button onclick="showScreen('menuScreen')">æˆ»ã‚‹</button>
      </section>

      <!-- éŸ³å£°è¨­å®š -->
      <section id="settingsScreen" class="screen" aria-label="éŸ³å£°è¨­å®š">
        <div class="setting-card">
          <label for="readySelect">Ready</label>
          <select id="readySelect" aria-describedby="readySelectHelp">
            <option value="Ready.mp3">On Your Marks</option>
            <option value="Ready-jp.mp3">ä½ç½®ã«ã¤ã„ã¦</option>
          </select>
          <small id="readySelectHelp" style="color:#a8c5ff;">ã‚¹ã‚¿ãƒ¼ãƒˆæº–å‚™éŸ³å£°ã‚’é¸æŠ</small>
        </div>
        <div class="setting-card">
          <label for="setSelect">Set</label>
          <select id="setSelect" aria-describedby="setSelectHelp">
            <option value="Set.mp3">Set</option>
            <option value="Set-jp.mp3">ã‚ˆãƒ¼ã„</option>
          </select>
          <small id="setSelectHelp" style="color:#a8c5ff;">ã‚¹ã‚¿ãƒ¼ãƒˆç›´å‰ã®éŸ³å£°ã‚’é¸æŠ</small>
        </div>
        <div class="setting-card">
          <label for="goSelect">ã‚¹ã‚¿ãƒ¼ãƒˆéŸ³</label>
          <select id="goSelect" aria-describedby="goSelectHelp">
            <option value="Go.mp3">ãƒ”ã‚¹ãƒˆãƒ«</option>
            <option value="whistle.mp3">ç¬›</option>
          </select>
          <small id="goSelectHelp" style="color:#a8c5ff;">ã‚¹ã‚¿ãƒ¼ãƒˆåˆå›³ã®éŸ³å£°ã‚’é¸æŠ</small>
        </div>
        <div class="setting-card">
          <label for="volumeControl">éŸ³å£°ãƒœãƒªãƒ¥ãƒ¼ãƒ </label>
          <input type="range" id="volumeControl" min="0" max="1" step="0.01" aria-valuemin="0" aria-valuemax="1" aria-valuenow="1" aria-label="éŸ³å£°ãƒœãƒªãƒ¥ãƒ¼ãƒ èª¿æ•´" />
        </div>
        <button onclick="showScreen('settingsMenuScreen')" aria-label="è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹">æˆ»ã‚‹</button>
      </section>

      <section id="startSettingsScreen" class="screen">
        <h2 style="text-align:center;">ã‚¹ã‚¿ãƒ¼ãƒˆè¨­å®š</h2>

        <!-- ã‚¿ãƒ– -->
        <div style="display:flex;justify-content:center;gap:24px;margin-bottom:16px;">
          <button onclick="showStartTab('fixed')" id="fixedTab" class="active-tab">å›ºå®šã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          <button onclick="showStartTab('random')" id="randomTab">ãƒ©ãƒ³ãƒ€ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>

        <!-- å›ºå®šã‚¹ã‚¿ãƒ¼ãƒˆè¨­å®š -->
<!-- å›ºå®šã‚¹ã‚¿ãƒ¼ãƒˆè¨­å®š -->
<div id="fixedSettings" class="start-tab">
  <h3 style="text-align:center;">å›ºå®šã‚¹ã‚¿ãƒ¼ãƒˆ</h3>
  <div class="setting-card" style="display:flex; flex-direction: column; align-items: center; gap: 32px;">

    <!-- ä½ç½®ã«ã¤ã„ã¦ -->
    <div style="display:flex; flex-direction: column; align-items: center; gap: 8px;">
      <label for="fixedReady" style="font-weight: bold;">ä½ç½®ã«ã¤ã„ã¦ ã¾ã§ã®æ™‚é–“ï¼ˆç§’ï¼‰</label>
      <img src="start1.png" alt="ä½ç½®ã«ã¤ã„ã¦" style="height: 60px;">
      <input type="number" id="fixedReady" value="3.0" min="0.1" max="10" step="0.1" style="width: 100px; text-align: center;">
    </div>

    <!-- ã‚ˆãƒ¼ã„ -->
    <div style="display:flex; flex-direction: column; align-items: center; gap: 8px;">
      <label for="fixedSet" style="font-weight: bold;">ã‚ˆãƒ¼ã„ ã¾ã§ã®æ™‚é–“ï¼ˆç§’ï¼‰</label>
      <img src="start2.png" alt="ã‚ˆãƒ¼ã„" style="height: 60px;">
      <input type="number" id="fixedSet" value="2.0" min="0.1" max="10" step="0.1" style="width: 100px; text-align: center;">
    </div>

    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆ -->
    <div style="display:flex; flex-direction: column; align-items: center; gap: 8px;">
      <label for="fixedGo" style="font-weight: bold;">ã‚¹ã‚¿ãƒ¼ãƒˆ ã¾ã§ã®æ™‚é–“ï¼ˆç§’ï¼‰</label>
      <img src="start3.png" alt="ã‚¹ã‚¿ãƒ¼ãƒˆ" style="height: 60px;">
      <input type="number" id="fixedGo" value="1.0" min="0.1" max="10" step="0.1" style="width: 100px; text-align: center;">
    </div>

  </div>
  <button onclick="saveFixedStartSettings()" style="margin-top: 16px;">ä¿å­˜</button>
</div>


        <!-- ãƒ©ãƒ³ãƒ€ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆè¨­å®š -->
        <div id="randomSettings" class="start-tab" style="display:none;">
          <h3 style="text-align:center;">ãƒ©ãƒ³ãƒ€ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</h3>
          <div class="setting-card" style="display:flex;flex-direction:column;align-items:center;gap:24px;">

<!-- ãƒ©ãƒ³ãƒ€ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼šä½ç½®ã«ã¤ã„ã¦ -->
<div style="display:flex;flex-direction:column;align-items:center; margin-bottom: 24px;">
  <label>ä½ç½®ã«ã¤ã„ã¦ ã¾ã§ã®æ™‚é–“ï¼ˆç§’ï¼‰</label>
  <div style="display: flex; align-items: center; gap: 12px;">
    <input type="number" id="minReady" value="2.0" step="0.1" min="1.0" max="4.0" style="width: 80px;"> ç§’
    <span>ã€œ</span>
    <input type="number" id="maxReady" value="4.0" step="0.1" min="1.0" max="4.0" style="width: 80px;"> ç§’
  </div>
  <img src="start1.png" alt="ä½ç½®ã«ã¤ã„ã¦" style="height: 60px; margin-top: 8px;">
</div>

<!-- ãƒ©ãƒ³ãƒ€ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼šã‚ˆãƒ¼ã„ -->
<div style="display:flex;flex-direction:column;align-items:center; margin-bottom: 24px;">
  <label>ã‚ˆãƒ¼ã„ ã¾ã§ã®æ™‚é–“ï¼ˆç§’ï¼‰</label>
  <div style="display: flex; align-items: center; gap: 12px;">
    <input type="number" id="minSet" value="1.5" step="0.1" min="1.0" max="4.0" style="width: 80px;"> ç§’
    <span>ã€œ</span>
    <input type="number" id="maxSet" value="3.0" step="0.1" min="1.0" max="4.0" style="width: 80px;"> ç§’
  </div>
  <img src="start2.png" alt="ã‚ˆãƒ¼ã„" style="height: 60px; margin-top: 8px;">
</div>

<!-- ãƒ©ãƒ³ãƒ€ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼šã‚¹ã‚¿ãƒ¼ãƒˆ -->
<div style="display:flex;flex-direction:column;align-items:center; margin-bottom: 24px;">
  <label>ã‚¹ã‚¿ãƒ¼ãƒˆ ã¾ã§ã®æ™‚é–“ï¼ˆç§’ï¼‰</label>
  <div style="display: flex; align-items: center; gap: 12px;">
    <input type="number" id="minGo" value="0.8" step="0.1" min="1.0" max="4.0" style="width: 80px;"> ç§’
    <span>ã€œ</span>
    <input type="number" id="maxGo" value="1.2" step="0.1" min="1.0" max="4.0" style="width: 80px;"> ç§’
  </div>
  <img src="start3.png" alt="ã‚¹ã‚¿ãƒ¼ãƒˆ" style="height: 60px; margin-top: 8px;">
</div>

          </div>
          <button onclick="saveRandomStartSettings()">ä¿å­˜</button>
        </div>

        <button onclick="showScreen('settingsMenuScreen')">æˆ»ã‚‹</button>
      </section>

      <!-- æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ -->
      <section id="manualScreen" class="screen" aria-label="æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰">
        <div id="measurementManual" aria-live="polite" aria-atomic="true">--.--.--</div>
        <button id="btnReady">ä½ç½®ã«ã¤ã„ã¦</button>
        <button id="btnSet">ã‚ˆãƒ¼ã„</button>
        <button id="btnStart">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <div class="extra-controls">
          <button id="btnStopManual">ã‚¹ãƒˆãƒƒãƒ—</button>
          <button id="btnResetManual">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <button onclick="showScreen('menuScreen')">æˆ»ã‚‹</button>
      </section>

      <!-- è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ -->
      <section id="autoScreen" class="screen" aria-label="è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰">
        <div class="setting-card">
          <div class="radio-group" id="autoModeRadioGroup" role="radiogroup" aria-label="è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰é¸æŠ">
            <label><input type="radio" name="autoMode" value="fixed" /> å›ºå®š</label>
            <label><input type="radio" name="autoMode" value="random" /> ãƒ©ãƒ³ãƒ€ãƒ </label>
          </div>
        </div>
        <div id="countdown" aria-live="polite" aria-atomic="true"></div>
        <div id="measurementAuto" aria-live="polite" aria-atomic="true">--.--.--</div>
        <button id="sequenceBtn">ã‚·ãƒ¼ã‚±ãƒ³ã‚¹é–‹å§‹</button>
        <div class="extra-controls">
          <button id="btnStopAuto">ã‚¹ãƒˆãƒƒãƒ—</button>
          <button id="btnResetAuto">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <button onclick="showScreen('menuScreen')">æˆ»ã‚‹</button>
      </section>
    </main>

  </div>

  <!-- Audio Elements -->
  <audio id="audioReady" src="Ready.mp3" preload="auto"></audio>
  <audio id="audioSet" src="Set.mp3" preload="auto"></audio>
  <audio id="audioGo" src="Go.mp3" preload="auto"></audio>

<script>
  // --- å…±é€šå¤‰æ•° ---
  let bleDevice = null;
  let bleServer = null;
  let bleCharacteristic = null;

  // BLEã‚µãƒ¼ãƒ“ã‚¹ãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯UUIDï¼ˆä¾‹ï¼‰
  const SERVICE_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb';
  const CHARACTERISTIC_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb';

  // éŸ³å£°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
  const audioReady = document.getElementById('audioReady');
  const audioSet = document.getElementById('audioSet');
  const audioGo = document.getElementById('audioGo');

  // UIè¦ç´ 
  const bleStatus = document.getElementById('bleStatus');
  const bleIcon = document.getElementById('bleIcon');
  const bleText = document.getElementById('bleText');
  const connectBtn = document.getElementById('connectBtn');

  const manualMeasurementDisplay = document.getElementById('measurementManual');
  const autoMeasurementDisplay = document.getElementById('measurementAuto');
  const countdownDisplay = document.getElementById('countdown');

  // è¨­å®šè¦ç´ 
  const readySelect = document.getElementById('readySelect');
  const setSelect = document.getElementById('setSelect');
  const goSelect = document.getElementById('goSelect');
  const volumeControl = document.getElementById('volumeControl');

  const timeReadyInput = document.getElementById('timeReady');
  const timeSetInput = document.getElementById('timeSet');
  const timeGoInput = document.getElementById('timeGo');

  // è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ãƒ©ã‚¸ã‚ª
  const autoModeRadios = document.getElementsByName('autoMode');
  const startModeRadios = document.getElementsByName('startMode');

  // æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
  const btnReady = document.getElementById('btnReady');
  const btnSet = document.getElementById('btnSet');
  const btnStart = document.getElementById('btnStart');
  const btnStopManual = document.getElementById('btnStopManual');
  const btnResetManual = document.getElementById('btnResetManual');

  // è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
  const sequenceBtn = document.getElementById('sequenceBtn');
  const btnStopAuto = document.getElementById('btnStopAuto');
  const btnResetAuto = document.getElementById('btnResetAuto');

  // çŠ¶æ…‹å¤‰æ•°
  let measurementManual = null;
  let measurementAuto = null;
  let countdownTimerId = null;
  let countdownValue = 0;

  // éŸ³å£°ãƒœãƒªãƒ¥ãƒ¼ãƒ åˆæœŸå€¤
  let audioVolume = 1.0;

  // BLE æ¥ç¶šçŠ¶æ…‹æ›´æ–°
  function updateBleStatus(connected) {
    if (connected) {
      bleIcon.textContent = 'ğŸŸ¢';
      bleText.textContent = 'æ¥ç¶šæ¸ˆã¿';
      connectBtn.textContent = 'åˆ‡æ–­';
    } else {
      bleIcon.textContent = 'ğŸ”´';
      bleText.textContent = 'æœªæ¥ç¶š';
      connectBtn.textContent = 'BLEæ¥ç¶š';
    }
  }

// BLEæ¥ç¶šå‡¦ç†ï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰
async function connectBle() {
  try {
    if (bleDevice && bleDevice.gatt.connected) {
      // åˆ‡æ–­å‡¦ç†
      await bleDevice.gatt.disconnect();
      updateBleStatus(false);
      return;
    }

    // â† await ã‚’è¿½åŠ 
    bleDevice = await navigator.bluetooth.requestDevice({
      filters: [{ services: ['0000ffe0-0000-1000-8000-00805f9b34fb'] }],
      optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb']
    });

    // â† ã“ã“ã§åˆã‚ã¦ bleDevice ãŒæœ‰åŠ¹ã«ãªã‚‹
    bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

    bleServer = await bleDevice.gatt.connect();
    const service = await bleServer.getPrimaryService(SERVICE_UUID);
    bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

    updateBleStatus(true);

    // é€šçŸ¥ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼ˆä»»æ„ï¼‰
    await bleCharacteristic.startNotifications();
    bleCharacteristic.addEventListener('characteristicvaluechanged', handleBleData);

  } catch (error) {
    console.error('BLEæ¥ç¶šå¤±æ•—:', error);
    alert('BLEæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    updateBleStatus(false);
  }
}

  // BLEåˆ‡æ–­æ™‚å‡¦ç†
  function onDisconnected() {
    console.log('BLEåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
    updateBleStatus(false);
  }

  // BLEã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å—ä¿¡å‡¦ç†
  function handleBleData(event) {
    const value = event.target.value;
    // å—ä¿¡ãƒã‚¤ãƒˆã‚’æ–‡å­—åˆ—ã«å¤‰æ›ï¼ˆä¾‹ï¼‰
    let receivedText = '';
    for (let i = 0; i < value.byteLength; i++) {
      receivedText += String.fromCharCode(value.getUint8(i));
    }
    // ä¾‹: å—ä¿¡ã—ãŸæ–‡å­—åˆ—ã‚’æ‰‹å‹•ãƒ»è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºã«åæ˜ 
    if (document.getElementById('manualScreen').classList.contains('active')) {
      manualMeasurementDisplay.textContent = receivedText;
    }
    if (document.getElementById('autoScreen').classList.contains('active')) {
      autoMeasurementDisplay.textContent = receivedText;
    }
  }

  // ç”»é¢åˆ‡æ›¿é–¢æ•°
  function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
  }

  // éŸ³å£°å†ç”Ÿé–¢æ•°ï¼ˆé¸æŠã•ã‚ŒãŸéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ã‚»ãƒƒãƒˆï¼‰
  function playAudio(type) {
    let audioElem;
    let filename;
    switch(type) {
      case 'ready':
        filename = readySelect.value;
        audioElem = audioReady;
        break;
      case 'set':
        filename = setSelect.value;
        audioElem = audioSet;
        break;
      case 'go':
        filename = goSelect.value;
        audioElem = audioGo;
        break;
      default:
        return;
    }
    if (audioElem.src.indexOf(filename) === -1) {
      audioElem.src = filename;
    }
    audioElem.volume = audioVolume;
    audioElem.currentTime = 0;
    audioElem.play();
  }

  // æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³å‡¦ç†
  btnReady.addEventListener('click', () => {
    playAudio('ready');
    //manualMeasurementDisplay.textContent = 'ä½ç½®ã«ã¤ã„ã¦';
    sendBle('READY');
  });
  btnSet.addEventListener('click', () => {
    playAudio('set');
    //manualMeasurementDisplay.textContent = 'ã‚ˆãƒ¼ã„';
    sendBle('SET');
  });
let manualTimerInterval = null;
let manualStartTime = null;

btnStart.addEventListener('click', () => {
  // æ—¢ã«ã‚¿ã‚¤ãƒãƒ¼ãŒå‹•ã„ã¦ã„ãŸã‚‰åœæ­¢
  if (manualTimerInterval) {
    clearInterval(manualTimerInterval);
    manualTimerInterval = null;
  }

  playAudio('go');
  //manualMeasurementDisplay.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆï¼';
  sendBle('GO');

  // è¨ˆæ¸¬ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
    manualStartTime = performance.now();

    manualTimerInterval = setInterval(() => {
      const elapsedMs = performance.now() - manualStartTime;
      const elapsedSec = elapsedMs / 1000;
      manualMeasurementDisplay.textContent = formatTime(elapsedSec);
    }, 10);

  });

  btnStopManual.addEventListener('click', () => {
    //manualMeasurementDisplay.textContent = 'ã‚¹ãƒˆãƒƒãƒ—';
    sendBle('STOP');
    if (manualTimerInterval) {
      clearInterval(manualTimerInterval);
      manualTimerInterval = null;
    }
  });

  btnResetManual.addEventListener('click', () => {
    manualMeasurementDisplay.textContent = '--.--.--';
    sendBle('RESET');
    if (manualTimerInterval) {
      clearInterval(manualTimerInterval);
      manualTimerInterval = null;
    }
  });

  // è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰
  let autoSequenceRunning = false;
  let autoTimers = [];

  sequenceBtn.addEventListener('click', () => {
    if (autoSequenceRunning) return;
    startAutoSequence();
  });
  btnStopAuto.addEventListener('click', stopAutoSequence);
  btnResetAuto.addEventListener('click', () => {
    stopAutoSequence();
    autoMeasurementDisplay.textContent = '--.--.--';
    countdownDisplay.textContent = '';
  });

  // è‡ªå‹•ã‚·ãƒ¼ã‚±ãƒ³ã‚¹é–‹å§‹
function startAutoSequence() {
  autoSequenceRunning = true;
  autoMeasurementDisplay.textContent = '--.--.--';

  let preCountdown = 5;  // å°æ•°ã§ã¯ãªãæ•´æ•°5ç§’
  countdownDisplay.textContent = preCountdown.toString();

  const preCountdownInterval = setInterval(() => {
    preCountdown -= 1;  // 1ç§’ãšã¤ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
    if (preCountdown <= 0) {
      clearInterval(preCountdownInterval);
      countdownDisplay.textContent = '';
      startSequenceAfterCountdown();
    } else {
      countdownDisplay.textContent = preCountdown.toString();
    }
  }, 1000);  // 1000ms = 1ç§’ã”ã¨ã«å®Ÿè¡Œ
}

function startSequenceAfterCountdown() {
  // å›ºå®š or ãƒ©ãƒ³ãƒ€ãƒ ã«å¿œã˜ã¦ç§’æ•°ã‚’å–å¾—
  let timeReady, timeSet, timeGo;

  const autoMode = [...autoModeRadios].find(r => r.checked)?.value || 'fixed';
  if (autoMode === 'fixed') {
    timeReady = parseFloat(document.getElementById('fixedReady').value) || 3.0;
    timeSet = parseFloat(document.getElementById('fixedSet').value) || 2.0;
    timeGo = parseFloat(document.getElementById('fixedGo').value) || 1.0;
  } else {
    // ãƒ©ãƒ³ãƒ€ãƒ ç¯„å›²å†…ã®ç§’æ•°ã‚’ãƒ©ãƒ³ãƒ€ãƒ æŠ½å‡º
    const minReady = parseFloat(document.getElementById('minReady').value) || 2.0;
    const maxReady = parseFloat(document.getElementById('maxReady').value) || 4.0;
    timeReady = Math.random() * (maxReady - minReady) + minReady;

    const minSet = parseFloat(document.getElementById('minSet').value) || 1.5;
    const maxSet = parseFloat(document.getElementById('maxSet').value) || 3.0;
    timeSet = Math.random() * (maxSet - minSet) + minSet;

    const minGo = parseFloat(document.getElementById('minGo').value) || 0.8;
    const maxGo = parseFloat(document.getElementById('maxGo').value) || 1.2;
    timeGo = Math.random() * (maxGo - minGo) + minGo;
  }

  clearAutoTimers();
  countdownValue = timeReady + timeSet + timeGo;

  // ä½ç½®ã«ã¤ã„ã¦
  autoTimers.push(setTimeout(() => {
    playAudio('ready');
    autoMeasurementDisplay.textContent = 'ä½ç½®ã«ã¤ã„ã¦';
    sendBle('READY');
  }, 0));

  // ã‚ˆãƒ¼ã„
  autoTimers.push(setTimeout(() => {
    playAudio('set');
    autoMeasurementDisplay.textContent = 'ã‚ˆãƒ¼ã„';
    sendBle('SET');
  }, timeReady * 1000));

  // ã‚¹ã‚¿ãƒ¼ãƒˆ
  autoTimers.push(setTimeout(() => {
    playAudio('go');
    autoMeasurementDisplay.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆï¼';
    sendBle('GO');
    startStopwatchAuto(); // â¬…ï¸ è¨ˆæ¸¬ã‚¿ã‚¤ãƒé–‹å§‹ï¼ˆè‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ï¼‰
  }, (timeReady + timeSet) * 1000));

  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º
  //const intervalMs = 100;
  //autoTimers.push(setInterval(() => {
  //  countdownValue -= intervalMs / 1000;
  //  if (countdownValue < 0) countdownValue = 0;
  //  countdownDisplay.textContent = countdownValue.toFixed(2);

  //  if (countdownValue <= 0) {
  //    clearAutoTimers();
  //    autoSequenceRunning = false;
  //  }
  //}, intervalMs));
}
  // ã‚¿ã‚¤ãƒãƒ¼ã‚¯ãƒªã‚¢
  function clearAutoTimers() {
    autoTimers.forEach(id => clearTimeout(id));
    autoTimers = [];
  }

function stopAutoSequence() {
  clearAutoTimers();
  if (window._autoTimerInterval) {
    clearInterval(window._autoTimerInterval);
    window._autoTimerInterval = null;
  }
  autoSequenceRunning = false;
  countdownDisplay.textContent = '';
}

  // BLEé€ä¿¡ï¼ˆæ–‡å­—åˆ—ï¼‰
  async function sendBle(message) {
    if (!bleCharacteristic) {
      console.warn('BLEæœªæ¥ç¶šã¾ãŸã¯Characteristicæœªå–å¾—');
      return;
    }
    try {
      const encoder = new TextEncoder();
      const data = encoder.encode(message);
      await bleCharacteristic.writeValue(data);
    } catch (error) {
      console.error('BLEé€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  // éŸ³å£°è¨­å®šä¿å­˜ï¼†åæ˜ 
  function loadSettings() {
    const savedVolume = localStorage.getItem('audioVolume');
    if (savedVolume !== null) {
      audioVolume = parseFloat(savedVolume);
      volumeControl.value = audioVolume;
    } else {
      volumeControl.value = 1.0;
      audioVolume = 1.0;
    }

    const savedReady = localStorage.getItem('readySelect');
    if (savedReady) readySelect.value = savedReady;
    const savedSet = localStorage.getItem('setSelect');
    if (savedSet) setSelect.value = savedSet;
    const savedGo = localStorage.getItem('goSelect');
    if (savedGo) goSelect.value = savedGo;

    const savedStartMode = localStorage.getItem('startMode');
    if (savedStartMode) {
      [...startModeRadios].forEach(r => r.checked = (r.value === savedStartMode));
    } else {
      startModeRadios[0].checked = true;
    }

    const savedAutoMode = localStorage.getItem('autoMode');
    if (savedAutoMode) {
      [...autoModeRadios].forEach(r => r.checked = (r.value === savedAutoMode));
    } else {
      autoModeRadios[0].checked = true;
    }

    const savedTimeReady = localStorage.getItem('timeReady');
    if (savedTimeReady) timeReadyInput.value = savedTimeReady;
    else timeReadyInput.value = 3.0;

    const savedTimeSet = localStorage.getItem('timeSet');
    if (savedTimeSet) timeSetInput.value = savedTimeSet;
    else timeSetInput.value = 2.0;

    const savedTimeGo = localStorage.getItem('timeGo');
    if (savedTimeGo) timeGoInput.value = savedTimeGo;
    else timeGoInput.value = 1.0;
  }

  function saveSettings() {
    localStorage.setItem('audioVolume', audioVolume);
    localStorage.setItem('readySelect', readySelect.value);
    localStorage.setItem('setSelect', setSelect.value);
    localStorage.setItem('goSelect', goSelect.value);

    const selectedStartMode = [...startModeRadios].find(r => r.checked)?.value;
    if (selectedStartMode) localStorage.setItem('startMode', selectedStartMode);

    const selectedAutoMode = [...autoModeRadios].find(r => r.checked)?.value;
    if (selectedAutoMode) localStorage.setItem('autoMode', selectedAutoMode);

    localStorage.setItem('timeReady', timeReadyInput.value);
    localStorage.setItem('timeSet', timeSetInput.value);
    localStorage.setItem('timeGo', timeGoInput.value);
  }

  // ã‚¹ã‚¿ãƒ¼ãƒˆè¨­å®šä¿å­˜
  function saveStartSettings() {
    saveSettings();
    alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  }

  // éŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
  volumeControl.addEventListener('input', (e) => {
    audioVolume = parseFloat(e.target.value);
    audioReady.volume = audioVolume;
    audioSet.volume = audioVolume;
    audioGo.volume = audioVolume;
  });

  // BLEæ¥ç¶šãƒœã‚¿ãƒ³
  connectBtn.addEventListener('click', connectBle);

  // åˆæœŸè¨­å®šèª­ã¿è¾¼ã¿
  loadSettings();

// ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒé–‹å§‹ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ï¼‰
function startStopwatchAuto() {
  const startTime = Date.now();
  if (window._autoTimerInterval) {
    clearInterval(window._autoTimerInterval);
  }
  window._autoTimerInterval = setInterval(() => {
    const elapsed = (Date.now() - startTime) / 1000;
    autoMeasurementDisplay.textContent = formatTime(elapsed);
  }, 50);
}


function formatTime(seconds) {
  if (seconds < 60) {
    return seconds.toFixed(2); // ä¾‹: 9.58
  } else {
    const min = Math.floor(seconds / 60);
    const sec = (seconds % 60).toFixed(2);

    // ç§’ãŒ1æ¡ã®ã¨ãã« "1:05.23" ã®ã‚ˆã†ã«æ•´ãˆã‚‹
    const [intSec, decSec] = sec.split(".");
    const paddedSec = intSec.padStart(2, "0") + "." + decSec;

    return `${min}:${paddedSec}`;
  }
}

  function saveRandomStartSettings() {
    localStorage.setItem('minReady', document.getElementById('minReady').value);
    localStorage.setItem('maxReady', document.getElementById('maxReady').value);
    localStorage.setItem('minSet', document.getElementById('minSet').value);
    localStorage.setItem('maxSet', document.getElementById('maxSet').value);
    localStorage.setItem('minGo', document.getElementById('minGo').value);
    localStorage.setItem('maxGo', document.getElementById('maxGo').value);
    alert('ãƒ©ãƒ³ãƒ€ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  }
  function showStartTab(type) {
    document.getElementById("fixedSettings").style.display = (type === "fixed") ? "block" : "none";
    document.getElementById("randomSettings").style.display = (type === "random") ? "block" : "none";
    document.getElementById("fixedTab").classList.toggle("active-tab", type === "fixed");
    document.getElementById("randomTab").classList.toggle("active-tab", type === "random");
  }

  function saveFixedStartSettings() {
    localStorage.setItem("fixedReady", document.getElementById("fixedReady").value);
    localStorage.setItem("fixedSet", document.getElementById("fixedSet").value);
    alert("å›ºå®šã‚¹ã‚¿ãƒ¼ãƒˆè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
  }

      // DOMèª­ã¿è¾¼ã¿å¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
    document.addEventListener("DOMContentLoaded", () => {
      const bleBtn = document.getElementById("connectBtn");
      if (bleBtn) {
        bleBtn.addEventListener("click", connectBLE);
      } else {
        console.error("BLEæ¥ç¶šãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      }
    });
</script>
</body>
</html>
